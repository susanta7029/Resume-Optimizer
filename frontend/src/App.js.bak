import React, { useState, useEffect } from 'react';
import { apiService } from './services/api';
import './App.css';

function App() {
  const [jobs, setJobs] = useState([]);
  const [selectedJob, setSelectedJob] = useState('');
  const [resumeFile, setResumeFile] = useState(null);
  const [loading, setLoading] = useState(false);
  const [results, setResults] = useState(null);
  const [error, setError] = useState('');
  const [toast, setToast] = useState({ show: false, message: '', type: '' });
  const [history, setHistory] = useState([]);
  const [showHistory, setShowHistory] = useState(false);

  // Fetch jobs on component mount
  useEffect(() => {
    fetchJobs();
  }, []);

  // Auto-hide toast after 4 seconds
  useEffect(() => {
    if (toast.show) {
      const timer = setTimeout(() => {
        setToast({ show: false, message: '', type: '' });
      }, 4000);
      return () => clearTimeout(timer);
    }
  }, [toast.show]);

  const showToast = (message, type = 'info') => {
    setToast({ show: true, message, type });
  };

  const fetchJobs = async () => {
    try {
      showToast(`${file.name} selected successfully`, 'success');
    } else {
      setError('Please select a PDF file');
      setResumeFile(null);
      showToast('Invalid file type. Please select a PDF file', 'error'.data);
        if (response.data.length === 0) {
          showToast('No job positions available. Please add some in the admin panel.', 'warning');
        }
      }
    } catch (err) {
      setError('Failed to load jobs. Make sure the backend server is running.');
      showToast('Failed to connect to backend server', 'error');
    }
  };

  const handleFileChange = (e) => {
    const file = e.target.files[0];
    if (file && file.type === 'application/pdf') {
      setResumeFile(file);
      setError('');
    } else {
      setError('Please select a PDF file');
      setResumeFile(null);
    }
  };

  const handleSubmit = async (e) => {
    e.  showToast('Resume analyzed successfully!', 'success');
      } else {
        setError(response.message || 'Analysis failed');
        showToast('Analysis failed. Please try again.', 'error');
      }
    } catch (err) {
      setError('Failed to analyze resume. Please try again.');
      showToast('Error connecting to server. Please try again.', 'error
    }
    
    if (!resumeFile) {
      setError('Please upload your resume');
      return;
    }

    showToast('Ready to analyze a new resume', 'info');
  };

  const downloadPDF = () => {
    showToast('Generating PDF...', 'info');
    // Create a simple text-based PDF content
    const pdfContent = `
RESUME ANALYSIS REPORT
======================

Match Score: ${results.rank}%
Status: ${results.rank >= 80 ? 'Excellent Match!' : results.rank >= 60 ? 'Good Match' : 'Needs Improvement'}

TOTAL EXPERIENCE: ${results.total_experience} years

SKILLS IDENTIFIED (${results.skills.length}):
${results.skills.map(skill => `â€¢ ${skill}`).join('\n')}

PROJECT CATEGORIES:
${results.project_categories.map(cat => `â€¢ ${cat}`).join('\n')}

${results.suggestions ? `\nSUGGESTIONS FOR IMPROVEMENT:\n${results.suggestions.map(s => `â€¢ ${s}`).join('\n')}` : ''}

Generated by Resume Analyzer - ${new Date().toLocaleDateString()}
    `.trim();

    const blob = new Blob([pdfContent], { type: 'text/plain' });
    const url = window.URL.createObjectURL(blob);
    co{toast.show && (
        <div className={`toast toast-${toast.type}`}>
          <span>{toast.message}</span>
          <button onClick={() => setToast({ show: false, message: '', type: '' })}>Ã—</button>
        </div>
      )}
      
      nst a = document.createElement('a');
    a.href = url;
    a.download = `resume-analysis-${Date.now()}.txt`;
    document.body.appendChild(a);
    a.click();
    window.URL.revokeObjectURL(url);
    document.body.removeChild(a);
    showToast('Report downloaded successfully!', 'success');
    setLoading(true);
    setError('');
    setResults(null);

    try {
      const response = await apiService.analyzeResume(selectedJob, resumeFile);
      if (response.status) {
        setResults(response.data);
      } else {
        setError(response.message || 'Analysis failed');
      }
    } catch (err) {
      setError('Failed to analyze resume. Please try again.');
    } finally {
      setLoading(false);
    }
  };

  const handleReset = () => {
    setSelectedJob('');
    setResumeFile(null);
    setResults(null);
    setError('');
  };

  const getScoreColor = (score) => {
    if (score >= 80) return '#10b981';
    if (score >= 60) return '#f59e0b';
    return '#ef4444';
  };

  return (
    <div className="App">
      <div className="container">
        <header className="(
                  <>
                    <span className="spinner"></span>
                    Analyzing...
                  </>
                )
          <h1>ðŸŽ¯ AI Resume Analyzer</h1>
          <p>Get instant feedback on how well your resume matches the job requirements</p>
        </header>

        {!results ? (
          <div className="upload-section">
            <form onSubmit={handleSubmit}>
              <div className="form-group">
                <label htmlFor="job-select">Select Job Position</label>
                <select
                  id="job-select"
                  value={selectedJob}
                  onChange={(e) => setSelectedJob(e.target.value)}
                  className="select-input"
                >
                  <option value="">-- Choose a position --</option>
                  {jobs.map((job) => (
                    <option key={job.id} value={job.id}>
                      {job.job_title}
                    </option>
                  ))}
                </select>
              </div>

              <div className="form-group">
                <label htmlFor="resume-upload">Upload Resume (PDF)</label>
                <div className="file-upload">
                  <input
                    type="file"
                    id="resume-upload"
                    accept=".pdf"
                    onChange={handleFileChange}
                    className="file-input"
                  />
                  <label htmlFor="resume-upload" className="file-label">
                    {resumeFile ? resumeFile.name : 'Choose PDF file'}
                  </label>
                </div>
              </div>

              {error && <div className="error-message">{error}</div>}

              {results.suggestions && results.suggestions.length > 0 && (
                <div className="detail-card suggestions-card">
                  <h3>ðŸ’¡ AI Suggestions for Improvement</h3>
                  <ul className="suggestions-list">
                    {results.suggestions.map((suggestion, index) => (
                      <li key={index}>{suggestion}</li>
                    ))}
                  </ul>
                </div>
              )}
            </div>

            <div className="action-buttons">
              <button onClick={downloadPDF} className="btn-download">
                ðŸ“¥ Download Report
              </button>
              <button onClick={handleReset} className="btn-secondary">
                ðŸ”„ Analyze Another Resume
              </button>
            </divbled={loading}
              >
                {loading ? 'Analyzing...' : 'Analyze Resume'}
              </button>
            </form>
          </div>
        ) : (
          <div className="results-section">
            <div className="score-card">
              <h2>Match Score</h2>
              <div 
                className="score-circle"
                style={{ borderColor: getScoreColor(results.rank) }}
              >
                <span className="score-value" style={{ color: getScoreColor(results.rank) }}>
                  {results.rank}%
                </span>
              </div>
              <p className="score-label">
                {results.rank >= 80 ? 'Excellent Match!' : 
                 results.rank >= 60 ? 'Good Match' : 'Needs Improvement'}
              </p>
            </div>

            <div className="details-grid">
              <div className="detail-card">
                <h3>ðŸ’¼ Total Experience</h3>
                <p className="detail-value">{results.total_experience} years</p>
              </div>

              <div className="detail-card">
                <h3>ðŸŽ¯ Skills Identified</h3>
                <div className="skills-container">
                  {results.skills && results.skills.map((skill, index) => (
                    <span key={index} className="skill-tag">{skill}</span>
                  ))}
                </div>
              </div>

              <div className="detail-card">
                <h3>ðŸ“‚ Project Categories</h3>
                <div className="categories-container">
                  {results.project_categories && results.project_categories.map((category, index) => (
                    <span key={index} className="category-tag">{category}</span>
                  ))}
                </div>
              </div>
            </div>

            <button onClick={handleReset} className="btn-secondary">
              Analyze Another Resume
            </button>
          </div>
        )}
      </div>
    </div>
  );
}

export default App;
